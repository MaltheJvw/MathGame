@page "/game/{ProfileId:int}"
@using MathGame.Services
@using MathGame.Model
@inject NavigationManager NavigationManager
@inject ProfileService ProfileService
@inject ProfileStateService ProfileStateService
@inject NumberService NumberService
@inject CalculationService CalculationService

@if (profileModel != null)
{
    @if (!isEditMode)
    {
        <div class="game-container">
            <!-- Top boxes -->
            <div class="box top-middle">
                <span>@boxes[0].MathProblem</span>
                <input @bind="boxes[0].Value" type="number" class="game-input @GetBoxCssClass(boxes[0])" />
            </div>
            <div class="box top-top">
                <span>@boxes[1].MathProblem</span>
                <input @bind="boxes[1].Value" type="number" class="game-input @GetBoxCssClass(boxes[1])" />
            </div>

            <!-- Middle row with left and right inputs and random number -->
            <div class="box left-middle">
                <span>@boxes[2].MathProblem</span>
                <input @bind="boxes[2].Value" type="number" class="game-input @GetBoxCssClass(boxes[2])" />
            </div>
            <div class="box left-left">
                <span>@boxes[3].MathProblem</span>
                <input @bind="boxes[3].Value" type="number" class="game-input @GetBoxCssClass(boxes[3])" />
            </div>
            <div class="box center">
                <span class="random-number">@randomNumber</span>
            </div>
            <div class="box right-middle">
                <span>@boxes[4].MathProblem</span>
                <input @bind="boxes[4].Value" type="number" class="game-input @GetBoxCssClass(boxes[4])" />
            </div>
            <div class="box right-right">
                <span>@boxes[5].MathProblem</span>
                <input @bind="boxes[5].Value" type="number" class="game-input @GetBoxCssClass(boxes[5])" />
            </div>

            <!-- Bottom boxes -->
            <div class="box bottom-middle">
                <span>@boxes[6].MathProblem</span>
                <input @bind="boxes[6].Value" type="number" class="game-input @GetBoxCssClass(boxes[6])" />
            </div>
            <div class="box bottom-bottom">
                <span>@boxes[7].MathProblem</span>
                <input @bind="boxes[7].Value" type="number" class="game-input @GetBoxCssClass(boxes[7])" />
            </div>
        </div>

        <div class="button-container">
            <button type="button" class="btn btn-primary" @onclick="HandleGenerateNewNumber">Generate New Number</button>
            <button type="button" class="btn btn-secondary" @onclick="HandleCheckMath">Check Math</button>
        </div>
    }
    else
    {
        
    }
}

<style>
    .game-container {
        display: grid;
        grid-template-rows: repeat(7, auto); /* Three rows for top, center, and bottom */
        grid-template-columns: repeat(5, auto); /* Five columns for plus sign layout */
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-top: 20px;
    }

    .box {
        display: flex;
        flex-direction: column; /* Stack math problem above the input */
        justify-content: center;
        align-items: center;
    }

    /* Position the boxes in the grid */
    .top-middle {
        grid-row: 2;
        grid-column: 3; /* Adjusted for new layout */
    }

    .top-top {
        grid-row: 1;
        grid-column: 3; /* Adjusted for new layout */
    }

    .left-middle {
        grid-row: 3;
        grid-column: 2; /* Adjusted for new layout */
    }

    .left-left {
        grid-row: 3; /* Same row as the center box */
        grid-column: 1; /* Left of the center box */
    }

    .center {
        grid-row: 3;
        grid-column: 3; /* Center box remains */
    }

    .right-middle {
        grid-row: 3;
        grid-column: 4; /* Adjusted for new layout */
    }

    .right-right {
        grid-row: 3; /* Same row as the center box */
        grid-column: 5; /* Right of the center box */
    }

    .bottom-middle {
        grid-row: 4;
        grid-column: 3; /* Adjusted for new layout */
    }

    .bottom-bottom {
        grid-row: 5;
        grid-column: 3; /* Adjusted for new layout */
    }

    .button-container {
        display: flex;
        justify-content: space-between; /* Align buttons on opposite sides */
        margin-top: 20px; /* Space above buttons */
    }

    .unchecked{
        background-color: white;
        color: white;
    }

    .correct {
        background-color: green;
        color: white;
    }

    .incorrect {
        background-color: red;
        color: white;
    }

    .game-input {
        width: 60px;
        height: 40px;
        font-size: 18px;
        text-align: center;
        border: 2px solid #333;
        border-radius: 8px;
        outline: none;
    }
</style>

@code {
    [Parameter]
    public int ProfileId { get; set; }

    private ProfileModel? profileModel;
    private bool isEditMode = false;

    // Declare variables for user input and random number
    private int randomNumber;
    private List<Box> boxes = new List<Box>();
    private bool hasCheckedMath = false;

    // This method is called when the component is initialized asynchronously
    protected override async Task OnInitializedAsync()
    {
        // Ensure ProfileId is coming from route parameters, not the state service
        if (ProfileId <= 0) // Check if the ProfileId is valid from the route
        {
            if (ProfileStateService.ProfileId.HasValue)
            {
                ProfileId = ProfileStateService.ProfileId.Value; // Only set if ProfileId is invalid
            }
        }

        profileModel = await ProfileService.LoadUserProfileAsync(ProfileId);
        if (profileModel == null)
        {
            NavigationManager.NavigateTo("/");
            return;
        }

        randomNumber = await NumberService.GenerateRandomNumberAsync(); // Get random number from the service
        await GenerateBoxes();
    }

    private async Task GenerateBoxes()
    {
        boxes.Clear(); // Clear existing boxes
        int[] adjustments = new int[] { -10, 10, -5, 5, -2, 2,-15, 15 }; // Possible adjustments
        foreach (var adjustment in adjustments)
        {
            int targetValue = randomNumber + adjustment;
            boxes.Add(new Box(targetValue)
                {
                    MathProblem = $"{adjustment:+#;-#;0}" // Format for displaying math problem
                });
        }
    }

    // New method to generate a new random number and update boxes
    private async Task HandleGenerateNewNumber()
    {
        isEditMode = false;
        hasCheckedMath = false;
        randomNumber = await NumberService.GenerateRandomNumberAsync();
        await GenerateBoxes();
        Console.WriteLine($"New random number generated: {randomNumber}"); // For debugging
    }

    private async Task HandleCheckMath()
    {
        isEditMode = !isEditMode;
        hasCheckedMath = true;

        foreach (var box in boxes)
        {
            box.IsCorrect = await CalculationService.IsMathCorrect(randomNumber, box.TargetValue, box.Value);
        }
    }

    private string GetBoxCssClass(Box box)
    {
        if (!hasCheckedMath)
            return string.Empty; // No class applied if math hasn't been checked yet

        if (box.IsCorrect)
            return "correct";
        else if (box.Value != 0) // Only highlight boxes that have a value entered
            return "incorrect";

        return string.Empty;
    }
}
